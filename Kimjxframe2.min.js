(function(){window.KJ={CONFIG:{root:"",start:"app.js",pageroot:"pages/",defaultframe:"main/main",defaultpage:"main/index",appdom:document.createElement("div"),runmode:"js",Templatemode:"default",TemplatemodeAPI:"",cachevesion:"",cachevesionkey:"kv",},EVENT:{hashchange:{},},JSCACHE:{},CSSCAHCE:{},HASH:{},LOADERCALLBACK:{},APP:{},APPLIST:[],DOMRENDER:{},init:function(config){var _this=KJ;for(var i in config){_this.CONFIG[i]=config[i]}Object.defineProperties(KJ,{cachevesionkey:{get:function(){return KJ.CONFIG.cachevesionkey},set:function(v){KJ.CONFIG.cachevesionkey=v}},cachevesion:{get:function(){return KJ.CONFIG.cachevesion},set:function(v){KJ.CONFIG.cachevesion=v}},});window.addEventListener("hashchange",_this.Fnhashchange,false);document.body.appendChild(_this.CONFIG.appdom);_this.Fnloader(_this.CONFIG.start)},Fneventdeal:function(name,data){var _this=KJ;for(var i in _this.EVENT[name]){if(data){_this.EVENT[name][i](data)}else{_this.EVENT[name][i]()}}},Fnregistevent:function(name,f){var _this=KJ;var id=new Date().getTime()+""+parseInt(Math.random()*10000);if(!_this.EVENT[name]){_this.EVENT[name]={}}_this.EVENT[name][id]=f;return id},Fnunregistevent:function(name,id){var _this=this;delete _this.EVENT[name][id];return true},Fnloader:function(u,callback){var _this=KJ;var url=_this.CONFIG.root+u;_this.Fnloadjs(url,function(){if(callback){callback()}})},Fnpageloader:function(u,callback){var pnf=u.split("."),ext,_this=KJ;if(pnf.length>1){ext=pnf[pnf.length-1]}else{ext=_this.CONFIG.runmode;u=u+"."+ext}if(ext=="js"){_this.FngetJsTemplate(u,callback)}else{_this.FngetTemplate(u,callback)}},FngetJsTemplate:function(u,callback){var _this=KJ;var url;if(_this.CONFIG.Templatemode=="api"){url=_this.CONFIG.root+_this.CONFIG.pageroot+_this.CONFIG.TemplatemodeAPI+"?page="+u+"&runmode=js"}else{url=_this.CONFIG.root+_this.CONFIG.pageroot+u}KJ.Fnloadjs(url,function(){if(callback){callback()}})},FngetTemplate:function(u,callback,fail){var _this=KJ;if(_this.APP[u]){if(callback){callback()}return}var url;if(_this.CONFIG.Templatemode=="api"){url=_this.CONFIG.root+_this.CONFIG.pageroot+_this.CONFIG.TemplatemodeAPI+"?page="+u+"&runmode=html"}else{if(u.split("?").length>1){url=_this.CONFIG.root+_this.CONFIG.pageroot+u+(KJ.CONFIG.cachevesion?"&"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"")}else{url=_this.CONFIG.root+_this.CONFIG.pageroot+u+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"")}}var xhr=new XMLHttpRequest();xhr.open("get",url,true);xhr.onload=function(){if((xhr.status>=200&&xhr.status<300)||xhr.status===0){_this.Fnregistpage(xhr.responseText,function(){if(callback){callback()}},u)}else{if(fail){fail()}else{_this.Fnregistpage("页面加载失败, errCode:"+xhr.status,function(){if(callback){callback()}},u)}}};xhr.send("")},getApp:function(u){var pnf=u.split(".");if(pnf.length<=1){u=u+"."+KJ.CONFIG.runmode}return KJ.APP[u]},Fnuse:function(list,callback){var _this=KJ;var count=0;var deal=function(){if(count>=list.length){if(callback){callback()}}else{if(list[count][1]=="css"){_this.Fnloadcss(list[count][0],function(){count++;deal()})}else{if(list[count][1]=="js"){_this.Fnloadjs(list[count][0],function(){count++;deal()})}}}};deal()},Fnloadjs:function(u,callback,fail){var _this=KJ;if(!_this.LOADERCALLBACK[u]){_this.LOADERCALLBACK[u]=[]}if(_this.JSCACHE[u]==2){if(callback){callback()}return false}if(_this.JSCACHE[u]==1){_this.LOADERCALLBACK[u].push(callback);return false}_this.LOADERCALLBACK[u].push(callback);_this.JSCACHE[u]=1;var script=_this.Fncel("script");script.onload=function(){_this.JSCACHE[u]=2;for(var i in _this.LOADERCALLBACK[u]){_this.LOADERCALLBACK[u][i]()}delete _this.LOADERCALLBACK[u];document.body.removeChild(script)};script.onerror=function(){if(fail){fail()}else{console.error([u,"加载失败！"])}};if(u.split("?").length>1){script.src=u+(KJ.CONFIG.cachevesion?"&"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"")}else{script.src=u+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"")}document.body.appendChild(script)},Fnloadcss:function(u,callback){var _this=KJ;if(!_this.LOADERCALLBACK[u]){_this.LOADERCALLBACK[u]=[]}if(_this.CSSCAHCE[u]==2){if(callback){callback()}return false}_this.LOADERCALLBACK[u].push(callback);_this.CSSCAHCE[u]=1;var link=_this.Fncel("link");link.rel="stylesheet";link.onload=function(){for(var i in _this.LOADERCALLBACK[u]){_this.LOADERCALLBACK[u][i]()}_this.CSSCAHCE[u]=2;delete _this.LOADERCALLBACK[u]};link.onerror=function(){console.error([u,"加载失败！"])};link.href=u+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"");document.head.appendChild(link)},Fncel:function(ename){return document.createElement(ename)},Fnregistpage:function(html,callback,name){var _this=KJ;var u=!name?_this.HASH.page:name;var pnf=u.split(".");if(pnf.length<=1){u=u+"."+KJ.CONFIG.runmode}_this.APP[u]=html;if(callback){callback()}},FngetGet:function(hash){var r={};var arr=hash.split("?");if(arr.length>1){arr=arr[1].split("&")}else{arr=[]}for(var i=0;
i<arr.length;i++){var s=arr[i].split("=");if(s.length>0&&s[0]!=""&&s[1]!=""){if(s.length==1){s[1]=""}r[s[0]]=decodeURIComponent(s[1])}}return r},Fnhashchange:function(e){var _this=KJ;if(e&&e.newURL){_this.HASH.rawURL=e?e.newURL:location.href;_this.HASH.oldURL=e?e.oldURL:location.href}else{_this.HASH.oldURL=_this.HASH.rawURL?_this.HASH.rawURL:"";_this.HASH.rawURL=location.href}var pageparam=_this.HASH.rawURL.split("#");var page=pageparam.length>1?pageparam[1].split("?")[0]:false;_this.HASH.page=page||_this.CONFIG.defaultpage;_this.HASH.GET=_this.FngetGet(pageparam.length>1?pageparam[1]:"");_this.Fneventdeal("hashchange",{e:e,hash:_this.HASH})},Fncleardocument:function(aim,flag){var list=aim.querySelectorAll("*");for(var i=0;i<list.length;i++){list[i].parentNode.removeChild(list[i])}if(flag){aim.parentNode.removeChild(aim)}}}})();