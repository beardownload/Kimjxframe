window.KJ={CONFIG:{root:"",start:"app.js",pageroot:"pages/",defaultframe:"main/main",defaultpage:"main/index",appdom:document.createElement("div"),runmode:"js",Templatemode:"default",TemplatemodeAPI:"",cachevesion:"",cachevesionkey:"kv",fileTagReg:/<(K-FILE)[^>]*>/gi,fileTag:"K-FILE"},EVENT:{hashchange:{}},JSCACHE:{},CSSCAHCE:{},HASH:{},LOADERCALLBACK:{},APP:{},APPLIST:[],DOMRENDER:{},init:function(e){var n=KJ;for(var t in e)n.CONFIG[t]=e[t];Object.defineProperties(KJ,{cachevesionkey:{get:function(){return KJ.CONFIG.cachevesionkey},set:function(e){KJ.CONFIG.cachevesionkey=e}},cachevesion:{get:function(){return KJ.CONFIG.cachevesion},set:function(e){KJ.CONFIG.cachevesion=e}}}),window.addEventListener("hashchange",n.Fnhashchange,!1),document.body.appendChild(n.CONFIG.appdom),n.Fnloader(n.CONFIG.start)},Fneventdeal:function(e,n){var t=KJ;for(var o in t.EVENT[e])n?t.EVENT[e][o](n):t.EVENT[e][o]()},Fnregistevent:function(e,n){var t=KJ,o=(new Date).getTime()+""+parseInt(1e4*Math.random());return t.EVENT[e]||(t.EVENT[e]={}),t.EVENT[e][o]=n,o},Fnunregistevent:function(e,n){return delete this.EVENT[e][n],!0},Fnloader:function(e,n){var t=KJ,o=t.CONFIG.root+e;t.Fnloadjs(o,function(){n&&n()})},Fnpageloader:function(e,n){var t,o=e.split("."),a=KJ;1<o.length?t=o[o.length-1]:e=e+"."+(t=a.CONFIG.runmode),"js"==t?a.FngetJsTemplate(e,n):a.FngetTemplate(e,n)},FnmultyPageLoader:function(e,n){if(e.length<=0)n();else{var t=e.length,o=0,a=function(){KJ.Fnpageloader(e[o],function(){t<=++o?n():a()})};a()}},FngetJsTemplate:function(e,n){var t,o=KJ;t="api"==o.CONFIG.Templatemode?o.CONFIG.root+o.CONFIG.pageroot+o.CONFIG.TemplatemodeAPI+"?page="+e+"&runmode=js":o.CONFIG.root+o.CONFIG.pageroot+e,KJ.Fnloadjs(t,function(){n&&n()})},FngetTemplate:function(e,n,t){var o=KJ;if(o.APP[e])n&&n();else{var a;a="api"==o.CONFIG.Templatemode?o.CONFIG.root+o.CONFIG.pageroot+o.CONFIG.TemplatemodeAPI+"?page="+e+"&runmode=html":1<e.split("?").length?o.CONFIG.root+o.CONFIG.pageroot+e+(KJ.CONFIG.cachevesion?"&"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:""):o.CONFIG.root+o.CONFIG.pageroot+e+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:"");var r=new XMLHttpRequest;r.open("get",a,!0),r.onload=function(){200<=r.status&&r.status<300||0===r.status?o.Fnregistpage(r.responseText,function(){n&&n()},e):t?t():o.Fnregistpage("页面加载失败, errCode:"+r.status,function(){n&&n()},e)},r.send("")}},getApp:function(e){return e.split(".").length<=1&&(e=e+"."+KJ.CONFIG.runmode),KJ.APP[e]},Fnuse:function(e,n){var t=KJ,o=0,a=function(){o>=e.length?n&&n():"css"==e[o][1]?t.Fnloadcss(e[o][0],function(){o++,a()}):"js"==e[o][1]&&t.Fnloadjs(e[o][0],function(){o++,a()})};a()},Fnloadjs:function(n,e,t){var o=KJ;if(o.LOADERCALLBACK[n]||(o.LOADERCALLBACK[n]=[]),2==o.JSCACHE[n])return e&&e(),!1;if(1==o.JSCACHE[n])return o.LOADERCALLBACK[n].push(e),!1;o.LOADERCALLBACK[n].push(e),o.JSCACHE[n]=1;var a=o.Fncel("script");a.onload=function(){for(var e in o.JSCACHE[n]=2,o.LOADERCALLBACK[n])o.LOADERCALLBACK[n][e]();delete o.LOADERCALLBACK[n],document.body.removeChild(a)},a.onerror=function(){t?t():console.error([n,"加载失败！"])},1<n.split("?").length?a.src=n+(KJ.CONFIG.cachevesion?"&"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:""):a.src=n+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:""),document.body.appendChild(a)},Fnloadcss:function(n,e){var t=KJ;if(t.LOADERCALLBACK[n]||(t.LOADERCALLBACK[n]=[]),2==t.CSSCAHCE[n])return e&&e(),!1;t.LOADERCALLBACK[n].push(e),t.CSSCAHCE[n]=1;var o=t.Fncel("link");o.rel="stylesheet",o.onload=function(){for(var e in t.LOADERCALLBACK[n])t.LOADERCALLBACK[n][e]();t.CSSCAHCE[n]=2,delete t.LOADERCALLBACK[n]},o.onerror=function(){console.error([n,"加载失败！"])},o.href=n+(KJ.CONFIG.cachevesion?"?"+KJ.CONFIG.cachevesionkey+"="+KJ.CONFIG.cachevesion:""),document.head.appendChild(o)},Fncel:function(e){return document.createElement(e)},FnFileExtendsDeal:function(e){return e.split(".").length<=1&&(e=e+"."+KJ.CONFIG.runmode),e},Fnregistpage:function(e,n,t){var o=KJ,a=t||o.HASH.page;a.split(".").length<=1&&(a=a+"."+KJ.CONFIG.runmode),o.FntemplateFileDeal(e,function(e){o.APP[a]=e,n&&n()},a)},FntemplateFileDeal:function(t,o,e){var a=KJ,n=KJ.Fncel("div"),r=t.match(KJ.CONFIG.fileTagReg),i=[],c="";if(e){var l=e.split("/");l.reverse(),l.splice(0,1),l.reverse(),c=l.join("/")}if(r&&0<r.length){n.innerHTML=r.join("");for(var s=n.querySelectorAll(KJ.CONFIG.fileTag),C=0;C<s.length;C++){var F=s[C].getAttribute("file").split("/");"."==F[0]&&(F[0]=c),i.push(F.join("/"))}KJ.FnmultyPageLoader(i,function(){for(var e=0;e<r.length;e++){var n=a.FnFileExtendsDeal(i[e]);t=t.replace(r[e],a.APP[n])}o(t)})}else o(t)},FngetGet:function(e){var n={},t=e.split("?");t=1<t.length?t[1].split("&"):[];for(var o=0;o<t.length;o++){var a=t[o].split("=");0<a.length&&""!=a[0]&&""!=a[1]&&(1==a.length&&(a[1]=""),n[a[0]]=decodeURIComponent(a[1]))}return n},Fnhashchange:function(e){var n=KJ;e&&e.newURL?(n.HASH.rawURL=e?e.newURL:location.href,n.HASH.oldURL=e?e.oldURL:location.href):(n.HASH.oldURL=n.HASH.rawURL?n.HASH.rawURL:"",n.HASH.rawURL=location.href);var t=n.HASH.rawURL.split("#"),o=1<t.length&&t[1].split("?")[0];n.HASH.page=o||n.CONFIG.defaultpage,n.HASH.GET=n.FngetGet(1<t.length?t[1]:""),n.Fneventdeal("hashchange",{e:e,hash:n.HASH})},Fncleardocument:function(e,n){for(var t=e.querySelectorAll("*"),o=0;o<t.length;o++)t[o].parentNode.removeChild(t[o]);n&&e.parentNode.removeChild(e)}};